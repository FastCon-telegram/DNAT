# NAT Bridge Manager v3.0 - XDP Edition

üöÄ –í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π DNAT –º–µ–Ω–µ–¥–∂–µ—Ä —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π XDP, nftables –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –¥–ª—è 10Gbit+

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### üîß Backend'—ã
- **iptables** ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π, —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π
- **nftables** ‚Äî –±—ã—Å—Ç—Ä–µ–µ iptables –Ω–∞ ~15-20%
- **XDP** ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞–∫–µ—Ç–æ–≤ –≤ –¥—Ä–∞–π–≤–µ—Ä–µ, –¥–æ 70% —Å–Ω–∏–∂–µ–Ω–∏—è CPU

### ‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- **Ring –±—É—Ñ–µ—Ä—ã** ‚Äî —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏ NIC
- **Interrupt Coalescing** ‚Äî –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π
- **Conntrack** ‚Äî –¥–æ 4M —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- **Softirq budget** ‚Äî 100K –ø–∞–∫–µ—Ç–æ–≤/—Ü–∏–∫–ª
- **–°–µ—Ç–µ–≤—ã–µ –±—É—Ñ–µ—Ä—ã** ‚Äî 128MB
- **IRQ Affinity** ‚Äî —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —è–¥—Ä–∞–º
- **Offload** ‚Äî GRO/GSO/TSO

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
wget -O /usr/local/bin/nat-manager https://raw.githubusercontent.com/FastCon-telegram/DNAT/main/nat-manager.sh
chmod +x /usr/local/bin/nat-manager
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```bash
sudo nat-manager
```

## –ú–µ–Ω—é

```
  1) üìã –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞
  2) ‚ûï –î–æ–±–∞–≤–∏—Ç—å
  3) ‚ö° –ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ
  4) üîÑ –í–∫–ª/–í—ã–∫–ª
  5) üóëÔ∏è  –£–¥–∞–ª–∏—Ç—å
  6) üìä –°—Ç–∞—Ç—É—Å
  7) üßπ –û—á–∏—Å—Ç–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã
  8) ‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è DNAT  ‚Üê –ù–û–í–û–ï
  9) üìà –°—Ç–∞—Ç—É—Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ ‚Üê –ù–û–í–û–ï
  0) üö™ –í—ã—Ö–æ–¥
```

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è 10Gbit

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ—Ä—è–¥–æ–∫:

1. **–ü—Ä–∏–º–µ–Ω–∏—Ç—å –±–∞–∑–æ–≤—É—é –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é** (–ø—É–Ω–∫—Ç 8 ‚Üí 8)
   - Ring –±—É—Ñ–µ—Ä—ã
   - Interrupt Coalescing
   - Conntrack 4M
   - Softirq 100K
   - –ë—É—Ñ–µ—Ä—ã 128MB
   - IRQ Affinity
   - Offload

2. **–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ nftables** (–ø—É–Ω–∫—Ç 8 ‚Üí 9)
   - –ë—ã—Å—Ç—Ä–µ–µ iptables –Ω–∞ 15-20%
   - –ú–µ–Ω—å—à–µ lock contention

3. **–í–∫–ª—é—á–∏—Ç—å XDP** (–¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
   ```
   8 ‚Üí 11 (—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)
   8 ‚Üí 12 (–≤–∫–ª—é—á–∏—Ç—å XDP)
   ```

## –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

| Backend | CPU –ø—Ä–∏ 5Gbit | Latency | –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å |
|---------|---------------|---------|---------------|
| iptables | 100% | 50-100Œºs | –û—Ç–ª–∏—á–Ω–∞—è |
| nftables | 80% | 40-80Œºs | –•–æ—Ä–æ—à–∞—è |
| XDP | 30% | 5-15Œºs | –¢—Ä–µ–±—É–µ—Ç –¥—Ä–∞–π–≤–µ—Ä |

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è XDP

```bash
apt install clang llvm libbpf-dev linux-headers-$(uname -r) bpftool
```

## –§–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

- `/etc/nat-bridge/rules.conf` ‚Äî –ø—Ä–∞–≤–∏–ª–∞ DNAT
- `/etc/nat-bridge/config.conf` ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (backend, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
- `/etc/nat-bridge/xdp/` ‚Äî XDP –ø—Ä–æ–≥—Ä–∞–º–º—ã

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

- Ubuntu 20.04+
- Debian 11+
- –Ø–¥—Ä–æ 5.4+ (–¥–ª—è XDP native)
- –Ø–¥—Ä–æ 4.8+ (–¥–ª—è XDP generic)

## Changelog

### v3.0-XDP
- –î–æ–±–∞–≤–ª–µ–Ω XDP backend
- –î–æ–±–∞–≤–ª–µ–Ω nftables backend
- –ú–µ–Ω—é –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ DNAT
- Ring –±—É—Ñ–µ—Ä—ã, Interrupt Coalescing
- Conntrack 4M, Softirq 100K
- IRQ Affinity, Offload

### v2.2
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã –ø—Ä–∞–≤–∏–ª
- –ò–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞
- –í–∫–ª/–í—ã–∫–ª –ø—Ä–∞–≤–∏–ª–∞

## –õ–∏—Ü–µ–Ω–∑–∏—è

MIT
